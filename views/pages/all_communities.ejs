<%- include('../partials/header'), { account : account } %>

<div class="wrapper">
    <div class="wrapper-content">
        <header class="header">
            <h1 class="content-title">All Communities</h1>
        </header>

        <div class="communities-listing main-page" style="padding-top: 10px;">
            <div class="commnities-new-added" id="community_wrapper">

                <% for (let i = 0; i < communities.length; i++) {
                    const community = communities[i];%>
                    
                    <li community="yes" id="community-<%= community.id %>" class="">
                    <span class="icon-content <%= (community.user_community == 1) ? "user-subcommunity" : "" %>">
                        <img class="icon" onerror="this.src='../../../img/app.png'" src="../../img/icons/<%= community.id %>.jpg">
                        <% if (community.user_community == 1) { %>
                            <img class="mii" src="http://mii-images.account.nintendo.net/<%= community.mii_hash %>_normal_face.png">
                        <% } %>
                    </span>
                    <a data-sound="SE_WAVE_OK" href="javascript:void(0)" onclick="pjax.loadUrl('/communities/<%= community.id %>/')" class="scroll to-community-button">
                        <span class="community-button"></span>
                    </a>
                    <div class="body">
                        <div class="body-content">
                            <span class="community-name title"><%= ((community.name).toString().includes("Community")) ? community.name : community.name + " Community"  %></span>
                            <span class="community-name name"><%= community.name %></span>
                            <span class="empathy-count"><%= community.favorites %></span>
                            <span class="text">
                                <% if (community.platform == "3ds") { %>Nintendo 3DS Games<% } else { %>Wii U Games<% } %>
                            </span>
                        </div>
                    </div>
                    </li>
                <% } %> 
            </div>

            <a class="loading" id="loading"></a>
        </div>

        <div id="scrollEvent"></div>
        <script>
            var nmc = false;
            var mkr = false;

            document.addEventListener("scroll_bottom", function() {
                if (nmc == true) {return;}
                if (mkr == true) {return;}

                var loading = document.getElementById("loading")
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/titles/communities?offset="+document.getElementById("community_wrapper").childElementCount);
                xhr.setRequestHeader("x-em", "true")
                xhr.send();
                mkr = true;

                loading.style.display = "block"

                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {

                        if (xhr.responseText == " ") {
                            nmc = true;
                            loading.style.display = "none";
                            return;
                        }

                        document.querySelectorAll("li")[document.querySelectorAll("li").length - 1].outerHTML += xhr.responseText;

                        mkr = false;

                        loading.style.display = "none";
                        aquamarine.initSounds();
                    }
                }
            })    
        </script>
    </div>
</div>